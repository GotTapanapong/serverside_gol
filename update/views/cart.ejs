<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MongCha | ตะกร้าสินค้า</title>
  <link rel="icon" type="image/png" href="/images/logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet" />
</head>

<body class="bg-[#74512D] min-h-screen flex flex-col font-[Kanit]">
  <!-- Navbar -->
  <%- include("partials/navbar_user") %>

    <!-- เนื้อหาหลัก -->
    <main class="flex flex-col justify-center items-center flex-1 mb-10 mt-5 px-6">
      <div class="bg-[#F8F4E1] p-8 rounded-2xl shadow-xl w-full max-w-4xl text-center">
        <h1 class="text-3xl font-extrabold text-[#543310] mb-4">ตะกร้าสินค้า</h1>

        <!-- ตารางสินค้า -->
        <div class="overflow-x-auto">
          <table class="w-full border border-gray-300 rounded-lg">
            <thead>
              <tr class="bg-[#e6d7b9] text-[#543310]">
                <th class="py-2 px-4 border">รูปภาพ</th>
                <th class="py-2 px-4 border">ชื่อเมนู</th>
                <th class="py-2 px-4 border">ราคาต่อแก้ว</th>
                <th class="py-2 px-4 border">ความหวาน</th>
                <th class="py-2 px-4 border">จำนวน</th>
                <th class="py-2 px-4 border">ราคารวม</th>
                <th class="py-2 px-4 border"></th>
              </tr>
            </thead>
            <tbody id="cart-list" class="text-gray-700"></tbody>
          </table>
        </div>

        <!-- รวมทั้งหมด -->
        <div class="mt-6 flex justify-center items-center text-lg text-[#543310] space-x-2">
          <span>รวมทั้งหมด:</span>
          <span id="totalPrice">฿0.00</span>
        </div>

        <!-- ปุ่มชำระเงิน -->
        <button id="payBtn"
          class="mt-6 bg-[#543310] text-[#F8F4E1] px-8 py-3 rounded-full hover:bg-[#6A4525] transition">
          ชำระเงิน
        </button>
      </div>
    </main>

    <script>
      // โหลดตะกร้าสินค้า
      async function loadCart() {
        try {
          const res = await fetch("/getCart");
          const data = await res.json();
          const cartList = document.getElementById("cart-list");
          cartList.innerHTML = "";
          let total = 0;

          if (!data.cart || data.cart.length === 0) {
            cartList.innerHTML = `
            <tr><td colspan="7" class="py-4 text-gray-500">ยังไม่มีสินค้าลงในตะกร้า</td></tr>`;
            document.getElementById("payBtn").disabled = true;
            document.getElementById("payBtn").classList.add("opacity-50", "cursor-not-allowed");
            document.getElementById("totalPrice").textContent = "฿0.00";
            return;
          }

          data.cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            const row = document.createElement("tr");
            row.innerHTML = `
            <td class='border py-2'><img src="${item.image_product}" alt="${item.productName}" class='w-20 h-auto rounded-lg mx-auto'></td>
            <td class='border py-2'>${item.productName}</td>
            <td class='border py-2 text-[#543310] font-bold'>฿${item.price.toFixed(2)}</td>
            <td class='border py-2'>${item.sweetness}</td>
            <td class='border py-2'>${item.quantity}</td>
            <td class='border py-2 text-[#543310] font-bold'>฿${itemTotal.toFixed(2)}</td>
            <td class='border py-2'>
              <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full transition" data-name="${item.productName}">
                ลบ
              </button>
            </td>
          `;
            cartList.appendChild(row);
          });

          document.getElementById("totalPrice").textContent = `฿${total.toFixed(2)}`;
        } catch (err) {
          console.error("Error loading cart:", err);
        }
      }

      // ลบสินค้า
      document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-btn")) {
          const productName = e.target.dataset.name;
          if (confirm(`ต้องการลบ "${productName}" ออกจากตะกร้าหรือไม่?`)) {
            try {
              const res = await fetch(`/removeFromCart/${encodeURIComponent(productName)}`, {
                method: "DELETE"
              });
              const data = await res.json();
              if (data.success) {
                alert("ลบสินค้าสำเร็จ!");
                loadCart();
              } else {
                alert("เกิดข้อผิดพลาด: " + data.message);
              }
            } catch (error) {
              console.error("Error deleting item:", error);
            }
          }
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const updateQuantity = async (productName, newQty) => {
          const res = await fetch("/updateCartQuantity", {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productName, quantity: newQty })
          });
          const data = await res.json();
          if (data.success) {
            location.reload(); // รีเฟรชตะกร้าใหม่
          } else {
            alert("เกิดข้อผิดพลาดในการอัปเดตจำนวนสินค้า");
          }
        };

        document.querySelectorAll(".increase-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const name = btn.dataset.name;
            const qtyElement = document.getElementById(`qty-${name.replace(/\s/g, '-')}`);
            const newQty = parseInt(qtyElement.textContent) + 1;
            updateQuantity(name, newQty);
          });
        });

        document.querySelectorAll(".decrease-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const name = btn.dataset.name;
            const qtyElement = document.getElementById(`qty-${name.replace(/\s/g, '-')}`);
            const currentQty = parseInt(qtyElement.textContent);
            if (currentQty > 1) {
              updateQuantity(name, currentQty - 1);
            }
          });
        });
      });


      // ปุ่มชำระเงิน
      document.getElementById("payBtn").addEventListener("click", () => {
        const totalPrice = document.getElementById("totalPrice").textContent.replace("฿", "");
        localStorage.setItem("totalPrice", totalPrice);
        window.location.href = "/payment";
      });

      // โหลดครั้งแรก
      loadCart();
    </script>
</body>

</html>

