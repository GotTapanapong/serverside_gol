<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เลือกที่อยู่</title>
    <link rel="stylesheet" href="/css/select_address.css">
</head>
<body>
    <h2>เลือกที่อยู่</h2>
    <div id="addressContainer">
        <p>กำลังโหลดที่อยู่...</p>
    </div>
    <button id="addAddressBtn" onclick="window.location.href='/address'">เพิ่มที่อยู่ใหม่</button>
    <button id="confirmAddress" disabled>เลือกที่อยู่นี้</button>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const addressContainer = document.getElementById("addressContainer");
            const confirmButton = document.getElementById("confirmAddress");
            let selectedAddress = null;
            let selectedAddressId = null; // <-- ตัวแปรสำหรับเก็บ ID

            try {
                const response = await fetch("/get-user-addresses");
                const data = await response.json();

                if (response.ok && data.addresses.length > 0) {
                    addressContainer.innerHTML = "";
                    data.addresses.forEach(address => {
                        const div = document.createElement("div");
                        div.classList.add("address-item");
                        div.innerHTML = `
                            <p><strong>${address.full_name}</strong></p>
                            <p>${address.phone_number}</p>
                            <p>${address.subdistrict}, ${address.district}, ${address.province}, ${address.postal_code}</p>
                        `;
                        
                        div.addEventListener("click", () => {
                            document.querySelectorAll(".address-item").forEach(el => el.classList.remove("selected"));
                            div.classList.add("selected");
                            
                            // เก็บข้อมูลทั้ง 2 อย่างเมื่อคลิก
                            selectedAddress = `${address.full_name}, ${address.subdistrict}, ${address.province}`;
                            selectedAddressId = address.address_id; // <-- เก็บ ID
                            
                            console.log(`Address ID ที่เลือก: ${selectedAddressId}`); // Log เพื่อตรวจสอบ
                            confirmButton.disabled = false;
                        });
                        addressContainer.appendChild(div);
                    });
                } else {
                    addressContainer.innerHTML = "<p>ยังไม่มีที่อยู่ที่บันทึกไว้</p>";
                }
            } catch (error) {
                console.error("❌ Error fetching addresses:", error);
                addressContainer.innerHTML = "<p>เกิดข้อผิดพลาดในการโหลดที่อยู่</p>";
            }

            confirmButton.addEventListener("click", () => {
                if (selectedAddress && selectedAddressId) {
                    // บันทึกข้อมูลทั้ง 2 อย่างลง localStorage
                    localStorage.setItem("selectedAddress", selectedAddress);
                    localStorage.setItem("selectedAddressId", selectedAddressId); // <-- บันทึก ID
                    
                    window.location.href = "/payment";
                }
            });
        });
    </script>
</body>
</html>