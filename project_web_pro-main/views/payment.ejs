<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONGCHA - Payment</title>
    <link rel="stylesheet" href="/css/payment.css">
</head>
<body>
    <nav id="navbar">
        <div class="navbar-header">
            <img src="/images/logo.png" alt="MONGCHA Logo" class="navbar-brand">
            <button id="menu-toggle" class="menu-toggle">☰</button>
        </div>
        <ul class="navbar-menu">
            <li><a href="#">หน้าหลัก</a></li>
            <li><a href="/menu">เมนู</a></li>
            <li><a href="/cart">ตะกร้า</a></li>
            <li><a href="/orders">คำสั่งซื้อ</a></li>
            <li><a href="/point">แต้ม</a></li>
            <li><a href="/about">เกี่ยวกับ</a></li>
            <li><a href="/logout" id="btn-logout" class="btn-logout">ลงชื่อออก</a></li>
        </ul>
    </nav>

    <div class="name_project">
        <img src="/images/logo.png" class="logomongcha" alt="">
    </div>

    <div class="container">
        <img src="/images/logo.png" alt="logomongcha" class="logo-medium">
        <div id="addressInput" class="input-box">
            <span id="selectedAddress">เลือกที่อยู่</span>
        </div>
        <div class="container">
            <img src="/images/qrcode.jpg" alt="QR Code" class="qr-image">
        </div>

        <form id="uploadForm">
            <label for="imageUpload" class="upload-label">
                <span>เพิ่มรูปใบเสร็จที่นี่</span>
                <input type="file" id="imageUpload" accept="image/*" required>
            </label>
            <div id="imagePreview" style="min-height: 150px; width: 100%; margin-top: 15px; border: 2px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9;">
                </div> 
            <button type="submit" id="submitButton" disabled>ดำเนินการต่อ</button>
        </form>
    </div>

<script>
    // โค้ด JavaScript ทั้งหมดเหมือนเดิม ไม่มีอะไรเปลี่ยนแปลงจากครั้งก่อน
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById('menu-toggle').addEventListener('click', function() { /* ... */ });
        // ... โค้ดที่เหลือทั้งหมดเหมือนเดิมเป๊ะ ...
        const selectedAddressText = localStorage.getItem("selectedAddress");
        if (selectedAddressText) {
            document.getElementById("selectedAddress").innerText = selectedAddressText;
        }
        document.getElementById("addressInput").addEventListener("click", function () {
            window.location.href = "/select_address";
        });
        const uploadForm = document.getElementById('uploadForm');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const submitButton = document.getElementById('submitButton');
        if (!uploadForm || !imageUpload || !imagePreview || !submitButton) {
            console.error("หา Element ที่จำเป็นไม่เจอ! โปรดตรวจสอบ ID ใน HTML");
            return;
        }
        imageUpload.addEventListener('change', () => {
            const file = imageUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 200px; height: auto; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
                submitButton.disabled = false;
            }
        });
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            submitButton.disabled = true;
            submitButton.innerText = 'กำลังดำเนินการ...';
            const selectedAddressId = localStorage.getItem("selectedAddressId");
            const finalTotalPrice = localStorage.getItem("totalPrice");
            const receiptFile = imageUpload.files[0];
            if (!selectedAddressId || !finalTotalPrice || !receiptFile) {
                alert("ข้อมูลไม่ครบถ้วน! กรุณาเลือกที่อยู่จากหน้าก่อนหน้าและอัปโหลดใบเสร็จ");
                submitButton.disabled = false;
                submitButton.innerText = 'ดำเนินการต่อ';
                return;
            }
            try {
                const orderResponse = await fetch('/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address_id: parseInt(selectedAddressId),
                        total_price: parseFloat(finalTotalPrice)
                    })
                });
                const orderResult = await orderResponse.json();
                if (!orderResult.success) throw new Error(orderResult.message || 'ไม่สามารถสร้างคำสั่งซื้อได้');
                const newOrderId = orderResult.orderId;
                const formData = new FormData();
                formData.append('receipt', receiptFile);
                formData.append('order_id', newOrderId);
                const uploadResponse = await fetch('/upload', { method: 'POST', body: formData });
                const uploadResult = await uploadResponse.json();
                if (!uploadResult.success) throw new Error(uploadResult.message || 'ไม่สามารถอัปโหลดใบเสร็จได้');
                alert(`สร้างคำสั่งซื้อสำเร็จ! หมายเลขคำสั่งซื้อของคุณคือ: ${newOrderId}`);
                localStorage.removeItem('selectedAddress');
                localStorage.removeItem('selectedAddressId');
                localStorage.removeItem('totalPrice');
                window.location.href = `/show-order-user/${newOrderId}`;
            } catch (error) {
                console.error('เกิดข้อผิดพลาด:', error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
                submitButton.disabled = false;
                submitButton.innerText = 'ดำเนินการต่อ';
            }
        });
    });
</script>
</body>
</html>