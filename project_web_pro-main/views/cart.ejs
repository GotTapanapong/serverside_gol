<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตะกร้าสินค้า</title>
    <link rel="stylesheet" href="/css/cart.css">
</head>

<body>
    <nav id="navbar">
        <div class="navbar-header">
            <img src="/images/logo.png" alt="MONGCHA Logo" class="navbar-brand">
            <button id="menu-toggle" class="menu-toggle">☰</button>
        </div>
        <ul class="navbar-menu">
            <li><a href="#">หน้าหลัก</a></li>
            <li><a href="/menu">เมนู</a></li>
            <li><a href="/cart">ตะกร้า</a></li>
            <li><a href="/orders">คำสั่งซื้อ</a></li>
            <li><a href="/about">เกี่ยวกับ</a></li>
            <li><a href="/logout" id="btn-logout" class="btn-logout">ลงชื่อออก</a></li>
        </ul>
    </nav>

    <div class="cart-container">
        <h1>ตะกร้าสินค้า</h1>
        
        <table id="cart-table">
            <thead>
                <tr>
                    <th>รูปภาพ</th>
                    <th>ชื่อเมนู</th>
                    <th>ราคาต่อแก้ว</th>
                    <th>ความหวาน</th>
                    <th>จำนวน</th>
                    <th>ราคารวม</th>
                </tr>
            </thead>
            <tbody id="cart-list">
                </tbody>
        </table>

        <div class="total-price">
            <strong>รวมทั้งหมด:</strong>
            <span id="totalPrice">฿0.00</span>
        </div>

        <button class="gopay" onclick="processPayment()">ชำระเงิน</button>
    </div>

    <script>
        document.getElementById('menu-toggle').addEventListener('click', function () {
            document.querySelector('.navbar-menu').classList.toggle('active');
        });

        // --- ดึงข้อมูลตะกร้ามาแสดงผล (เวอร์ชันตัด Topping และ แต้ม ออก) ---
        fetch("/getCart")
            .then(response => response.json())
            .then(data => {
                const cartList = document.getElementById("cart-list");
                cartList.innerHTML = "";
                let total = 0;

                if (!data.cart || data.cart.length === 0) {
                    // แก้ไข colspan จาก 7 เป็น 6
                    cartList.innerHTML = "<tr><td colspan='6'>ยังไม่มีสินค้าลงในตะกร้า</td></tr>";
                    document.querySelector('.gopay').disabled = true;
                    return;
                }

                data.cart.forEach(item => {
                    const row = document.createElement("tr");
                    const itemTotalPrice = item.price * item.quantity;
                    total += itemTotalPrice;

                    // แก้ไข row.innerHTML โดยลบคอลัมน์ topping ออก
                    row.innerHTML = `
                        <td><img src="data:image/png;base64,${item.image_product}" alt="${item.productName}" width="80"></td>
                        <td>${item.productName}</td>
                        <td>฿${item.price.toFixed(2)}</td>
                        <td>${item.sweetness}</td>
                        <td>${item.quantity}</td>
                        <td>฿${itemTotalPrice.toFixed(2)}</td>
                    `;
                    cartList.appendChild(row);
                });

                document.getElementById("totalPrice").textContent = `฿${total.toFixed(2)}`;
            })
            .catch(error => console.error("Error loading cart:", error));

        
        // --- ฟังก์ชันชำระเงิน (เวอร์ชันตัดระบบแต้มออก) ---
        function processPayment() {
            // 1. ดึงราคารวมสุดท้ายจากหน้าเว็บ
            const finalTotalPrice = document.getElementById("totalPrice").textContent.replace("฿", "");

            // 2. บันทึกราคารวมลง localStorage
            localStorage.setItem("totalPrice", finalTotalPrice);
            console.log(`บันทึกราคารวม ${finalTotalPrice} ลง localStorage แล้ว`);

            // 3. ไปยังหน้าชำระเงินทันที
            window.location.href = "/payment";
        }
    </script>
</body>
</html>